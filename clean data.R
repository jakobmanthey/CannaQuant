# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# PROJECT TITLE:  CANNAQUANT
# CODE AUTHOR:    JM
# DATE STARTED:   240322

# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 0) ESSENTIALS
# ______________________________________________________________________________________________________________________

# clean workspace
rm(list=ls())

# input and output path
path <- paste0("data/")

# load libraries
library( data.table )
library( ggplot2 )
library( ggthemes )
library( tidyr )
library( stringr )

# themes and options
theme_set( theme_gdocs() )
options(scipen = 999)


# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 1) LOAD DATA
# ______________________________________________________________________________________________________________________

##  1) GERMANY
# -------------------------------------------------------

filename <- paste0(path,"Germany/data/CQ germany.xlsx")

input1 <- data.table(openxlsx::read.xlsx(filename))
dim(input1) # 699 * 60


##  2) ...
# -------------------------------------------------------



# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 2) PREPARE DATA
# ______________________________________________________________________________________________________________________

data <- copy(input1)

# keep relevant variables:
str(input1)

data <- data[,.(country = "Germany",
                studyID,male,educ,age,
                frequency,freq_v1,freq_v2,
                pref_type,
                thc_flower,thc_resin,thc_other,thc_avg,
                cast_tot,highrisk,
                cw_tot_flowers,cw_tot_resin,
                total_flower,size_flower,n_flower_weekday,n_flower_weekend,
                total_resin,total_cannabis,total_thc)]


# keep only if complete in sex, age, edu
data[!complete.cases(data[,.(male,age,educ)])]  # remove 329 rows
data[complete.cases(data[,.(male,age,educ)])]  # keep 370 rows
data <- data[complete.cases(data[,.(male,age,educ)])]  # keep 370 rows



# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 3) DEFINE VARIABLES
# ______________________________________________________________________________________________________________________

##  1) Sociodemographics
#   .............................................

# sex
data[, table(male, useNA = "always")] # 0 missing values
data[, sex := dplyr::recode(male, "1" = "men", "0" = "women")]
data[, table(sex, useNA = "always")] # 0 missing values
data$male <- NULL

# agegroup
data[, table(age, useNA = "always")] # 0 missing values
data[, agegroup := ifelse(age < 25, "18-24",
                          ifelse(age < 35, "25-34",
                                 ifelse(age < 45, "35-44",
                                        ifelse(age < 55, "45-54",
                                               ifelse(age < 99, "55-73", "===")))))]
data[, table(age, agegroup)]
data[, table(agegroup, useNA = "always")]

# education
data[, table(educ, useNA = "always")] # 0 missing values
data[, edugroup := ifelse(educ < 3, "low", # Haupt/Real
                          ifelse(educ < 8, "mid", # Fachhochschulreife/Abitur
                                 ifelse(educ == 8, "high", "===")))] # Studium
data[, table(educ, edugroup)]
data[, table(edugroup, useNA = "always")]
data$edugroup <- factor(data$edugroup, levels = c("low","mid","high"))

                                        
##  2) CAST
#   .............................................

data[, table(cast_tot, useNA = "always")]


##  3) Cannabis Frequency
#   .............................................

# version
data[, table(frequency,freq_v1)]
data[, table(frequency,freq_v2)]

# v1
data[, table(freq_v1, useNA = "always")] # 191 missing values

# v2
data[, table(freq_v2, useNA = "always")] # 199 missing values

# joint freq
data$freq <- NA_real_
data[, freq := ifelse(frequency == 1, 4.285 * freq_v1,freq_v2)]
data[, summary(freq)]
data[, freqgroup := ifelse(freq < 10, "1-9",
                           ifelse(freq < 20, "10-19",
                                  ifelse(freq < 29, "20-28","29-30")))]
data[, table(freq, freqgroup, useNA = "always")] # 20 NA


##  4) Cannabis Amount - CWA
#   .............................................

data[, table(cw_tot_flowers, useNA = "always")] # 103 missings
data[, table(cw_tot_resin, useNA = "always")] # 310 missings


##  5) Cannabis Amount - CQ
#   .............................................

data[, table(pref_type, useNA = "always")] # 336 flower, 17 resin
data[, pref_type := dplyr::recode(pref_type, 
                                  "0" = "other",
                                  "1" = "flower",
                                  "2" = "resin")]

# flower
data[, table(total_flower, useNA = "always")] # 34 NA
data[, table(is.na(total_flower))] # 34 NA, 336 valid

data[, table(is.na(total_flower), frequency,useNA = "always")]
data[, table(is.na(total_flower), n_flower_weekday,useNA = "always")]
data[, table(is.na(total_flower), n_flower_weekend,useNA = "always")]
data[, table(is.na(total_flower), size_flower, useNA = "always")]

data[, table(total_resin, useNA = "always")] # 353 NA
data[, table(total_cannabis, useNA = "always")] # 17 NA

##  6) THC
#   .............................................

data[, table(thc_avg, useNA = "always")] # 73 NA
data$thc_avg <- round(data$thc_avg,3)
data[, table(total_thc, useNA = "always")] # 88 NA
data$total_thc <- round(data$total_thc,3)

data[, thc_label := dplyr::recode(thc_avg,
                                  .missing = "unknown",
                                  "0.025" = "0-4.9%",
                                  "0.075" = "5-9.9%",
                                  "0.125" = "10-14.9%",
                                  "0.175" = "15-19.9%",
                                  "0.225" = "20-24.9%",
                                  "0.275" = "25-29.9%",
                                  "0.3" = "30%+")]
data[, table(thc_label, thc_avg, useNA = "always")]

# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 3) FIGURE
# ______________________________________________________________________________________________________________________

##  
pdat <- copy(data)


# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 4) SAVE
# ______________________________________________________________________________________________________________________

out <- data[,.(country,studyID,
               sex,age,agegroup,edugroup,
               freqgroup,
               pref_type,
               thc_avg,thc_label,
               cast_tot,highrisk,
               cw_tot_flowers,cw_tot_resin,
               total_flower,total_resin,total_cannabis,total_thc)]

write.csv(out, paste0(path,"DE_cleaned_data.csv"), row.names = F)
